<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Anime Template">
    <meta name="keywords" content="Anime, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Anims | Anime</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Css Styles -->
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="css/plyr.css" type="text/css">
    <link rel="stylesheet" href="css/nice-select.css" type="text/css">
    <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="css/style.css" type="text/css">
</head>

<body>
    <!-- Page Preloder -->
    <div id="preloder">
        <div class="loader"></div>
    </div>

    <!-- Header Section Begin -->
    <header class="header">
        <div class="container">
            <div class="row">
                <div class="col-lg-2">
                    <div class="header__logo">
                        <a href="./index.html">
                            <img src="img/logo.png" alt="">
                        </a>
                    </div>
                </div>
                <div class="col-lg-7">
                    <div class="header__nav">
                        <nav class="header__menu mobile-menu">
                            <ul>
                                <li><a href="./index.html">Página Inicial</a></li>
                                <li class="active"><a href="./categories.html">Animes</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div id= "header__right" class="header__right">
                        <div class="dropdown">
                            <button class="dropbtn"><span class="icon_profile"></span></button>
                            <div class="dropdown-content">
                                <a id="entrar" class="login" href="login.html">Entrar</a>
                                <a id="signup" href="signup.html">Cadastrar</a>
                                <a onclick="logout(event)" id="logout-link" style="display: none;">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="mobile-menu-wrap"></div>
        </div>
    </header>
    <!-- Header End -->

    <!-- Breadcrumb Begin -->
    <div class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__links">
                        <a href="./index.html"><i class="fa fa-home"></i>Início</a>
                        <a href="./categories.html">Categorias</a>
                        <span>Ação</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Anime Section Begin -->
    <section class="anime-details spad">
        <div class="container">
            <div class="anime__details__content">
                <div class="row">
                    <div class="col-lg-3">
                        <div class="anime__details__pic set-bg" data-setbg="">
                            <div class="comment"><i class="fa fa-star"></i> <span
                                class="comments-count"></span></div>
                            <div class="view"><i class="fa fa-star nota"></i></div>
                        </div>
                    </div>
                    <div class="col-lg-9">
                        <div class="anime__details__text">
                            <div class="anime__details__title">
                                <h3 class="titulo"></h3>
                                <span class="title2"></span>
                            </div>
                            <p class="sinopse"></p>
                            <div class="anime__details__widget">
                                <div class="row">
                                    <div class="col-lg-6 col-md-6">
                                        <ul>
                                            <li class="tipo"></li>
                                            <li class="estudio"></li>
                                            <li class="lancamento"></li>
                                            <li class="status"></li>
                                            <li class="genres"></li>
                                        </ul>
                                    </div>
                                    <div class="col-lg-6 col-md-6">
                                        <ul>
                                            <li class="score"></li>
                                            <li class="ep"></li>
                                            <li class="duracao"></li>
                                            <li class="views"></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="anime__details__btn">
                                <a href="" class="watch-btn"><span>Assista Agora</span> <i
                                        class="fa fa-angle-right"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 col-md-12">
                    <div class="anime__details__review">
                        <div class="section-title">
                            <h5>Reviews</h5>
                        </div>
                        <div class="anime__review__item" id="anime__review__item">
                            <!-- <div class="anime__review__item__pic">
                                <img src="img/anime/review-1.jpg" alt="">
                            </div> -->
                            <!-- <div class="anime__review__item__text" id="anime__review__item__text">
                                <h6 id="user"><span id="date"></span></h6>
                                <p id="content"></p>
                            </div> -->
                        </div>
                    </div>
                    <div class="anime__details__form">
                        <div class="section-title">
                            <h5>Deixe seu comentário!</h5>
                        </div>
                        <form onsubmit="postComment(event)">
                            <div>
                                <textarea id="comment" placeholder="Comente" required></textarea>
                            </div>
                            <button id="review-button" type="submit" class="site-btn">Review</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Anime Section End -->

    <!-- Footer Section Begin -->
    <footer class="footer">
        <div class="page-up">
            <a href="#" id="scrollToTopButton"><span class="arrow_carrot-up"></span></a>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <div class="footer__logo">
                        <a href="./index.html"><img src="img/logo.png" alt=""></a>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="footer__nav">
                        <ul>
                            <li class="active"><a href="./index.html">Página Inicial</a></li>
                            <li><a href="./categories.html">Animes</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- Footer Section End -->

    <!-- Js Plugins -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/player.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/mixitup.min.js"></script>
    <script src="js/jquery.slicknav.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/main.js"></script>

    <script>
        // IDs dos animes que serão buscados na API Jikan
        var url = window.location.href;

        // Criar um objeto URLSearchParams com a query string da URL
        var searchParams = new URLSearchParams(new URL(url).search);

        // Obter o valor do parâmetro "id"
        var id = searchParams.get('id');

        var animeIds2 = [id]; // Exemplo de IDs de animes
        var apiUrl = 'https://api.jikan.moe/v4/anime/';

        // Função para buscar dados de um anime específico pelo ID
        function fetchAnimeData(animeId) {
            return new Promise(function (resolve, reject) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', apiUrl + animeId);
                xhr.responseType = 'json';
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        resolve(xhr.response.data);
                    } else {
                        reject(Error('Erro ao carregar dados do anime'));
                    }
                };
                xhr.onerror = function () {
                    reject(Error('Erro de rede ao tentar carregar dados do anime'));
                };
                xhr.send();
            });
        }

        // Promessas para buscar os dados de todos os animes
        var requests = animeIds2.map(function (animeId) {
            return fetchAnimeData(animeId);
        });

        // Executar todas as promessas
        Promise.all(requests).then(function (animes) {
            // Processar os resultados
            animes.forEach(function (anime, index) {
                // Selecionando o elemento HTML correspondente ao anime
                var animeItem = document.querySelectorAll('.anime__details__content')[index];

                // Preenchendo os elementos com os dados do anime
                var animePic = animeItem.querySelector('.anime__details__pic');
                animePic.style.backgroundImage = 'url(' + anime.images.webp.large_image_url + ')';

                var animeEps = animeItem.querySelector('.ep');
                animeEps.innerHTML = anime.episodes > 0 ? `<span>Episodios:</span> ${anime.episodes}` : `<span>Episodios:</span> ?`

                var animeTitle = animeItem.querySelector('.titulo')
                animeTitle.textContent = anime.title

                var animeTitlejap = animeItem.querySelector('.title2')
                animeTitlejap.textContent = anime.title_english

                var animeSinopsis = animeItem.querySelector('.sinopse')
                animeSinopsis.textContent = anime.synopsis

                var animeType = animeItem.querySelector('.tipo')
                animeType.innerHTML = `<span>Tipo:</span> ${anime.type}`

                var animeStudio = animeItem.querySelector('.estudio')
                animeStudio.innerHTML = `<span>Estúdio:</span> ${anime.studios[0].name}`

                var animeLaunch = animeItem.querySelector('.lancamento')
                animeLaunch.innerHTML = `<span>Lançamento:</span> ${anime.aired.string}`

                var animeStatus = animeItem.querySelector('.status')
                animeStatus.innerHTML = `<span>Status:</span> ${anime.status}`

                var animeGenre = animeItem.querySelector('.genres')
                var genresString = `<span>Gêneros:</span>`;
                anime.genres.forEach(function (genre, idx) {
                    genresString += genre.name;
                    if (idx < anime.genres.length - 1) {
                        genresString += ', '; // Adiciona vírgula entre os gêneros, exceto no último
                    }
                });
                animeGenre.innerHTML = genresString;

                var animeScore = animeItem.querySelector('.score')
                animeScore.innerHTML = `<span>Notas:</span> ${anime.score + ' / ' + anime.scored_by}`

                var animeDuration = animeItem.querySelector('.duracao')
                animeDuration.innerHTML = `<span>Duração:</span> ${anime.duration}`

                var animeViews = animeItem.querySelector('.views')
                animeViews.innerHTML = `<span>Membros:</span> ${anime.members}`

                var commentsCount = animeItem.querySelector('.comments-count');
                commentsCount.innerHTML = " " + anime.score;

                var animeWatch = animeItem.querySelector('.watch-btn')
                animeWatch.setAttribute('href', anime.trailer.url)
                animeWatch.setAttribute('target', '_blank');

                var animeScore1 = animeItem.querySelector('.nota')
                animeScore1.innerHTML = " Rank: " + anime.rank

                var animeItem2 = document.querySelectorAll('.breadcrumb-option')[index]

                var animeGenre2 = animeItem2.querySelector('.breadcrumb__links')
                animeGenre2.innerHTML = `<a href="./index.html"><i class="fa fa-home"></i>Início</a>
                        <a href="./categories.html">Categorias</a>
                        <span>${anime.genres[0].name}<span>`

                console.log(animes)
            });

        }).catch(function (error) {
            console.error('Erro ao carregar dados dos animes:', error);
        });
    </script>

<script>    
    function checkLogin() {
            const userId = localStorage.getItem('userId');
            const loginLink = document.getElementById('entrar');
            const signupLink = document.getElementById('signup');
            const logoutLink = document.getElementById('logout-link');

            if (userId) {
                if (loginLink) {
                    loginLink.style.display = 'none';
                }
                if (signupLink) {
                    signupLink.style.display = 'none';
                }
                if (logoutLink) {
                    logoutLink.style.display = 'block';
                }
            } else {
                if (loginLink) loginLink.style.display = 'block';
                if (signupLink) signupLink.style.display = 'block';
                if (logoutLink) logoutLink.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', checkLogin);

        function logout() {
            localStorage.removeItem('userId');
            localStorage.removeItem('user')
            window.location.href = 'index.html';
        }

        function nickname() {
            const username = localStorage.getItem('user');

            if (username) {
                var header = document.getElementById('header__right');

                // Remove qualquer elemento com a classe 'nickname' existente para evitar duplicação
                var existingNickname = document.querySelector('.nickname');
                if (existingNickname) {
                    existingNickname.remove();
                }

                var namenick = document.createElement('h6');
                namenick.innerHTML = `Bem-vindo(a) - <span>${username}</span>`;
                namenick.classList.add('nickname');
                header.appendChild(namenick);
            }
        }

    // Execute a função após o carregamento do DOM
        document.addEventListener('DOMContentLoaded', nickname);

</script>

    <script>
            async function postComment(event) {
            event.preventDefault(); // Previne o envio padrão do formulário

            var url = window.location.href;
            var searchParams = new URLSearchParams(new URL(url).search);
            var id = searchParams.get('id');

            const comment = document.getElementById('comment').value;
            const userId = localStorage.getItem('userId');
            const username = localStorage.getItem('user')
            const anime = Number(id); // Usa o ID obtido da URL

            const data = {
                content: comment,
                userId: userId, // Certifique-se de que este é o nome correto do campo
                animeId: anime,
                username: username
            };

            if (userId) { // Verifica se userId não é nulo ou vazio
                try {
                    const response = await fetch('http://localhost:3001/comment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    alert('Comentário feito com sucesso!');
                    window.location.reload()
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao enviar o comentário');
                }
            } else {
                alert('Por favor faça login antes de comentar! :)');
            }
    }
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        var url = window.location.href;
        var searchParams = new URLSearchParams(new URL(url).search);
        var id = searchParams.get('id');
        const anime = Number(id); // Usa o ID obtido da URL

        fetch(`http://localhost:3001/lookcomment/${anime}`)
        .then(response => response.json())
        .then(data => {
            var commentListElement = document.getElementById('anime__review__item');

            data.comment.forEach( comment => {
                var commentPic = document.createElement('div');
                commentPic.classList.add('anime__review__item__pic');
                commentListElement.appendChild(commentPic); 

                var commentImg = document.createElement('img');
                commentImg.src = "img/anime/review-1.jpg"
                commentPic.appendChild(commentImg)

                var commentBox = document.createElement('div')
                commentBox.classList.add('anime__review__item__text')
                commentListElement.appendChild(commentBox)

                var commentName = document.createElement('h6');
                commentName.innerHTML = comment.username + " - "
                commentBox.appendChild(commentName); 

                var commentDate = document.createElement('span');
                commentDate.innerHTML = comment.date.length > 10 ? comment.date.substring(0, 10) : comment.date 
                commentName.appendChild(commentDate); 

                var commentContent = document.createElement('p');
                commentContent.innerHTML = comment.content
                commentBox.appendChild(commentContent); 
            });
            console.log(data)
        })
        .catch(error => {
            console.error('Error fetching comment:', error);
        });
    })
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var commentInput = document.getElementById('comment');
            var reviewButton = document.getElementById('review-button');

            commentInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Evita o comportamento padrão do Enter (submissão do formulário, por exemplo)
                    reviewButton.click();   // Simula o clique no botão "Search"
                }
            });
        });
    </script>

</body>
</html>